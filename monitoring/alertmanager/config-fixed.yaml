# =============================================================================
# CONFIGURATION ALERTMANAGER - RNCP 39394
# Expert en Syst√®mes d'Information et S√©curit√©
# 
# Notification multi-canaux + escalade automatique
# Conformit√© ISA/IEC 62443 + tra√ßabilit√© compl√®te
# =============================================================================

global:
  # Configuration SMTP pour notifications email
  smtp_smarthost: 'smtp.company.com:587'
  smtp_from: 'alertes-rncp39394@company.com'
  smtp_auth_username: 'alert-service@company.com'
  smtp_auth_password_file: '/run/secrets/alertmanager_smtp_password'
  smtp_require_tls: true
  
  # Templates personnalis√©s
  smtp_hello: 'alertmanager.rncp-39394.local'

# =============================================================================
# CONFIGURATION DES ROUTES D'ALERTE
# =============================================================================
route:
  # Param√®tres globaux de groupement
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 30s        # Attente avant envoi groupe
  group_interval: 5m     # Intervalle entre envois group√©s
  repeat_interval: 4h    # R√©p√©tition si non acquitt√©e
  
  # R√©cepteur par d√©faut
  receiver: 'default-alerts'
  
  # Routes sp√©cialis√©es par criticit√© et composant
  routes:
  
  # =============================================================================
  # ALERTES CRITIQUES - NOTIFICATION IMM√âDIATE
  # =============================================================================
  - match:
      severity: critical
    receiver: 'critical-alerts'
    group_wait: 0s         # Notification imm√©diate
    group_interval: 1m
    repeat_interval: 30m   # R√©p√©tition toutes les 30min si non r√©solue
    routes:
    
    # AI Engine critique - Escalade rapide
    - match:
        component: ai-engine
        severity: critical
      receiver: 'ai-engine-critical'
      group_wait: 0s
      
    # S√©curit√© IoT critique - Notification √©quipe SOC
    - match:
        type: security
        severity: critical
      receiver: 'security-team'
      group_wait: 0s
      
    # Infrastructure critique - Notification ops
    - match:
        component: infrastructure
        severity: critical
      receiver: 'ops-team-critical'
      group_wait: 0s

  # =============================================================================
  # ALERTES WARNING - NOTIFICATION DIFF√âR√âE
  # =============================================================================
  - match:
      severity: warning
    receiver: 'warning-alerts'
    group_wait: 2m
    group_interval: 10m
    repeat_interval: 2h
    
  # =============================================================================
  # ALERTES CONFORMIT√â - NOTIFICATION √âQUIPE AUDIT
  # =============================================================================
  - match:
      type: compliance
    receiver: 'compliance-team'
    group_wait: 5m
    group_interval: 30m
    repeat_interval: 12h

# =============================================================================
# D√âFINITION DES R√âCEPTEURS
# =============================================================================
receivers:

# -----------------------------------------------------------------------------
# R√©cepteur par d√©faut
# -----------------------------------------------------------------------------
- name: 'default-alerts'
  email_configs:
  - to: 'admin@company.com'
    from: 'alertes-rncp39394@company.com'
    subject: '[RNCP 39394] Alerte Syst√®me - {{ .GroupLabels.alertname }}'
    html: |
      <h2>üîî Alerte Plateforme IoT AI - RNCP 39394</h2>
      <p><strong>Criticit√©:</strong> {{ .CommonLabels.severity }}</p>
      <p><strong>Composant:</strong> {{ .CommonLabels.component }}</p>
      <p><strong>Description:</strong> {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}</p>
      <p><strong>Timestamp:</strong> {{ .CommonAnnotations.timestamp }}</p>
      
# -----------------------------------------------------------------------------
# Alertes critiques - Notification multi-canaux
# -----------------------------------------------------------------------------
- name: 'critical-alerts'
  # Email urgent
  email_configs:
  - to: 'admin@company.com, ops@company.com'
    from: 'alertes-rncp39394@company.com'
    subject: 'üö® [CRITIQUE] RNCP 39394 - {{ .GroupLabels.alertname }}'
    html: |
      <div style="background-color:#ff4444; color:white; padding:15px; border-radius:5px;">
        <h1>üö® ALERTE CRITIQUE - INTERVENTION IMM√âDIATE</h1>
        <h2>Plateforme IoT AI - RNCP 39394</h2>
      </div>
      
      <h3>üìä D√©tails de l'alerte:</h3>
      <ul>
        {{ range .Alerts }}
        <li><strong>{{ .Labels.alertname }}</strong>: {{ .Annotations.summary }}</li>
        <li><strong>Description:</strong> {{ .Annotations.description }}</li>
        <li><strong>Composant:</strong> {{ .Labels.component }}</li>
        <li><strong>Instance:</strong> {{ .Labels.instance }}</li>
        <li><strong>D√©but:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}</li>
        {{ if .Annotations.runbook_url }}
        <li><strong>Runbook:</strong> <a href="{{ .Annotations.runbook_url }}">Proc√©dure de r√©solution</a></li>
        {{ end }}
        {{ end }}
      </ul>
      
      <h3>üéØ Actions requises:</h3>
      <p>1. V√©rifier le dashboard Grafana: <a href="https://grafana.rncp-39394.local">Monitoring</a></p>
      <p>2. Consulter les logs Splunk pour investigation approfondie</p>
      <p>3. D√©clencher proc√©dure d'escalade si n√©cessaire</p>
      
      <hr>
      <small>Alerte g√©n√©r√©e par Prometheus - RNCP 39394 Expert SI & S√©curit√©</small>
      
  # Slack critique
  slack_configs:
  - api_url_file: '/run/secrets/slack_webhook_url'
    channel: '#rncp-39394-critical'
    title: 'üö® Alerte Critique RNCP 39394'
    text: |
      *{{ .GroupLabels.alertname }}* - Intervention imm√©diate requise
      
      {{ range .Alerts }}
      ‚Ä¢ *Composant:* {{ .Labels.component }}
      ‚Ä¢ *Severit√©:* {{ .Labels.severity }}
      ‚Ä¢ *Description:* {{ .Annotations.summary }}
      ‚Ä¢ *Instance:* {{ .Labels.instance }}
      {{ if .Annotations.runbook_url }}
      ‚Ä¢ *Runbook:* {{ .Annotations.runbook_url }}
      {{ end }}
      {{ end }}
      
      üìä <https://grafana.rncp-39394.local|Dashboard Grafana>
    color: 'danger'

# -----------------------------------------------------------------------------
# AI Engine critique - Escalade sp√©cialis√©e
# -----------------------------------------------------------------------------
- name: 'ai-engine-critical'
  email_configs:
  - to: 'ai-team@company.com, cto@company.com'
    from: 'alertes-rncp39394@company.com'
    subject: 'üéØ [AI ENGINE CRITIQUE] RNCP 39394 - Performance d√©grad√©e'
    html: |
      <div style="background-color:#ff6600; color:white; padding:15px;">
        <h1>üéØ ALERTE AI ENGINE - PERFORMANCE CRITIQUE</h1>
        <p>Le moteur d'IA RNCP 39394 n√©cessite une intervention imm√©diate</p>
      </div>
      
      <h3>üìà M√©triques critiques:</h3>
      {{ range .Alerts }}
      <p><strong>{{ .Labels.alertname }}:</strong> {{ .Annotations.description }}</p>
      {{ end }}
      
      <h3>üîß Actions de d√©pannage:</h3>
      <ol>
        <li>V√©rifier la latence P95 (objectif < 0.28ms)</li>
        <li>Contr√¥ler la pr√©cision du mod√®le (minimum 97.6%)</li>
        <li>Analyser les logs d'inf√©rence</li>
        <li>Valider les ressources GPU</li>
      </ol>
      
  # PagerDuty pour escalade automatique
  pagerduty_configs:
  - routing_key: '1234567890abcdef'
    description: 'AI Engine RNCP 39394 - Performance critique'

# -----------------------------------------------------------------------------
# √âquipe s√©curit√© - Cyberattaques et anomalies
# -----------------------------------------------------------------------------
- name: 'security-team'
  email_configs:
  - to: 'security@company.com, soc@company.com'
    from: 'alertes-rncp39394@company.com'
    subject: 'üõ°Ô∏è [S√âCURIT√â] RNCP 39394 - Incident de s√©curit√© d√©tect√©'
    html: |
      <div style="background-color:#cc0000; color:white; padding:15px;">
        <h1>üõ°Ô∏è INCIDENT DE S√âCURIT√â - RNCP 39394</h1>
        <p>Anomalie ou cyberattaque d√©tect√©e sur la plateforme IoT AI</p>
      </div>
      
      <h3>üîç D√©tails de l'incident:</h3>
      {{ range .Alerts }}
      <p><strong>{{ .Labels.alertname }}:</strong> {{ .Annotations.summary }}</p>
      <p><strong>Type:</strong> {{ .Labels.type }}</p>
      <p><strong>Composant:</strong> {{ .Labels.component }}</p>
      <p><strong>Description:</strong> {{ .Annotations.description }}</p>
      {{ end }}
      
      <h3>‚ö° Actions imm√©diates:</h3>
      <ol>
        <li>Isoler le composant affect√© si n√©cessaire</li>
        <li>V√©rifier les logs de s√©curit√© dans Splunk</li>
        <li>Activer le plan de r√©ponse aux incidents</li>
        <li>Notifier le RSSI</li>
      </ol>

# -----------------------------------------------------------------------------
# √âquipe op√©rationnelle - Infrastructure critique
# -----------------------------------------------------------------------------
- name: 'ops-team-critical'
  email_configs:
  - to: 'ops@company.com, infra@company.com'
    from: 'alertes-rncp39394@company.com'
    subject: '‚ö° [INFRA CRITIQUE] RNCP 39394 - Probl√®me infrastructure'
    html: |
      <div style="background-color:#ff8800; color:white; padding:15px;">
        <h1>‚ö° INFRASTRUCTURE CRITIQUE</h1>
        <p>Probl√®me critique d√©tect√© sur l'infrastructure RNCP 39394</p>
      </div>
      
      {{ range .Alerts }}
      <p><strong>{{ .Labels.alertname }}:</strong> {{ .Annotations.summary }}</p>
      <p><strong>Instance:</strong> {{ .Labels.instance }}</p>
      <p><strong>Description:</strong> {{ .Annotations.description }}</p>
      {{ end }}

# -----------------------------------------------------------------------------
# Alertes warning - Notification standard
# -----------------------------------------------------------------------------
- name: 'warning-alerts'
  email_configs:
  - to: 'admin@company.com'
    from: 'alertes-rncp39394@company.com'
    subject: '‚ö†Ô∏è [WARNING] RNCP 39394 - {{ .GroupLabels.alertname }}'
    html: |
      <h2>‚ö†Ô∏è Alerte Warning - RNCP 39394</h2>
      {{ range .Alerts }}
      <p><strong>{{ .Labels.alertname }}:</strong> {{ .Annotations.summary }}</p>
      {{ end }}

# -----------------------------------------------------------------------------
# √âquipe conformit√© - Audit et compliance
# -----------------------------------------------------------------------------
- name: 'compliance-team'
  email_configs:
  - to: 'compliance@company.com, audit@company.com'
    from: 'alertes-rncp39394@company.com'
    subject: 'üìã [CONFORMIT√â] RNCP 39394 - Probl√®me de conformit√©'
    html: |
      <div style="background-color:#6600cc; color:white; padding:15px;">
        <h1>üìã PROBL√àME DE CONFORMIT√â</h1>
        <p>Non-conformit√© d√©tect√©e sur la plateforme RNCP 39394</p>
      </div>
      
      {{ range .Alerts }}
      <p><strong>{{ .Labels.alertname }}:</strong> {{ .Annotations.summary }}</p>
      <p><strong>Type:</strong> {{ .Labels.type }}</p>
      <p><strong>Description:</strong> {{ .Annotations.description }}</p>
      {{ end }}
      
      <h3>üìù Actions requises:</h3>
      <ol>
        <li>V√©rifier la tra√ßabilit√© des √©v√©nements</li>
        <li>Contr√¥ler les proc√©dures d'audit</li>
        <li>Documenter l'incident</li>
        <li>Impl√©menter les corrections n√©cessaires</li>
      </ol>

# =============================================================================
# TEMPLATES PERSONNALIS√âS
# =============================================================================
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# =============================================================================
# CONFIGURATION D'INHIBITION
# =============================================================================
inhibit_rules:
  # Supprimer les alertes warning si critique active
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'cluster', 'service']
    
  # Supprimer les alertes de disponibilit√© si maintenance
  - source_match:
      alertname: 'MaintenanceMode'
    target_match:
      type: 'availability'
    equal: ['instance']
