# Station TraffeyÃ¨re IoT/AI Platform - AlertManager Configuration
# Gestion des alertes et notifications via Slack

global:
  # Configuration globale
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alertmanager@station-traffeyere.com'
  smtp_auth_username: 'alertmanager@station-traffeyere.com'
  smtp_auth_password: '${SMTP_PASSWORD}'
  
  # Templates pour les notifications
  slack_api_url: '${SLACK_WEBHOOK_URL}'

# Configuration des templates de messages
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Groupage des alertes
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook.slack'
  routes:
    # Alertes critiques - notification immÃ©diate
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      group_interval: 5s
      repeat_interval: 15m
      
    # Alertes sÃ©curitÃ© - notification prioritaire
    - match:
        service: security
      receiver: 'security-alerts'
      group_wait: 30s
      group_interval: 2m
      repeat_interval: 30m
      
    # Alertes business critical - escalade immÃ©diate
    - match_re:
        service: 'station-operations|water-quality|treatment-process'
      receiver: 'business-critical'
      group_wait: 0s
      group_interval: 1m
      repeat_interval: 10m
      
    # Alertes IoT/AI - monitoring spÃ©cialisÃ©
    - match_re:
        service: 'iot-generator|edge-ai|iot-sensors'
      receiver: 'iot-ai-alerts'
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 1h
      
    # Alertes infrastructure - groupage standard
    - match:
        service: infrastructure
      receiver: 'infrastructure-alerts'
      group_wait: 5m
      group_interval: 10m
      repeat_interval: 2h
      
    # Alertes base de donnÃ©es
    - match_re:
        service: 'postgresql|redis|influxdb'
      receiver: 'database-alerts'
      group_wait: 1m
      group_interval: 3m
      repeat_interval: 30m

# Inhibition rules - Ã©viter les alertes redondantes
inhibit_rules:
  # Inhiber les alertes warning si critical existe
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service']
    
  # Inhiber les alertes de service si le node est down
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      service: '.*'
    equal: ['instance']

# Configuration des rÃ©cepteurs de notifications
receivers:
  # Webhook par dÃ©faut vers Slack
  - name: 'web.hook.slack'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#station-monitoring'
        title: 'Station TraffeyÃ¨re - Alerte GÃ©nÃ©rale'
        title_link: 'https://grafana.johann-lebel.fr'
        text: >-
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          _Service:_ `{{ .Labels.service }}`
          _Severity:_ `{{ .Labels.severity }}`
          _Runbook:_ {{ .Labels.runbook }}
          {{ end }}
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        actions:
          - type: button
            text: 'View in Grafana'
            url: 'https://grafana.johann-lebel.fr'
          - type: button
            text: 'Runbook'
            url: '{{ (index .Alerts 0).Labels.runbook }}'

  # Alertes critiques - canal prioritaire
  - name: 'critical-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#station-critical'
        title: 'ğŸš¨ ALERTE CRITIQUE - Station TraffeyÃ¨re'
        title_link: 'https://grafana.johann-lebel.fr'
        text: >-
          @here {{ range .Alerts }}
          **CRITIQUE:** {{ .Annotations.summary }}
          
          ğŸ“Š *DÃ©tails:* {{ .Annotations.description }}
          ğŸ”§ *Service:* `{{ .Labels.service }}`
          â° *Depuis:* {{ .StartsAt.Format "15:04:05" }}
          ğŸ“š *Runbook:* {{ .Labels.runbook }}
          {{ end }}
          
          âš ï¸ **Action immÃ©diate requise**
        color: 'danger'
        actions:
          - type: button
            text: 'ğŸ“Š Grafana Dashboard'
            url: 'https://grafana.johann-lebel.fr'
          - type: button
            text: 'ğŸ“š Documentation'
            url: '{{ (index .Alerts 0).Labels.runbook }}'
          - type: button
            text: 'ğŸ” Prometheus'
            url: 'https://prometheus.johann-lebel.fr'

  # Alertes sÃ©curitÃ©
  - name: 'security-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#station-security'
        title: 'ğŸ” Alerte SÃ©curitÃ© - Station TraffeyÃ¨re'
        title_link: 'https://grafana.johann-lebel.fr'
        text: >-
          @channel {{ range .Alerts }}
          **SÃ‰CURITÃ‰:** {{ .Annotations.summary }}
          
          ğŸ›¡ï¸ *DÃ©tails:* {{ .Annotations.description }}
          ğŸ¯ *Service:* `{{ .Labels.service }}`
          ğŸ“… *Timestamp:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          ğŸ“– *Investigation:* {{ .Labels.runbook }}
          {{ end }}
          
          ğŸ” **Analyse de sÃ©curitÃ© requise**
        color: 'warning'
        actions:
          - type: button
            text: 'ğŸ” Security Dashboard'
            url: 'https://grafana.johann-lebel.fr/d/security/security-dashboard'
          - type: button
            text: 'ğŸ“‹ Incident Response'
            url: '{{ (index .Alerts 0).Labels.runbook }}'

  # Alertes business critical
  - name: 'business-critical'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#station-operations'
        title: 'ğŸ’¼ Alerte OpÃ©rationnelle Critique'
        title_link: 'https://grafana.johann-lebel.fr'
        text: >-
          @here {{ range .Alerts }}
          **OPÃ‰RATIONS CRITIQUES:** {{ .Annotations.summary }}
          
          ğŸ’§ *Impact:* {{ .Annotations.description }}
          âš™ï¸ *Processus:* `{{ .Labels.service }}`
          â±ï¸ *DurÃ©e:* {{ .StartsAt.Format "15:04:05" }}
          ğŸ“‹ *ProcÃ©dure:* {{ .Labels.runbook }}
          {{ end }}
          
          ğŸ­ **Impact sur traitement d'eau - Intervention urgente**
        color: 'danger'
        actions:
          - type: button
            text: 'ğŸ­ Station Dashboard'
            url: 'https://grafana.johann-lebel.fr/d/station/station-overview'
          - type: button
            text: 'ğŸ“Š Water Quality'
            url: 'https://grafana.johann-lebel.fr/d/water/water-quality-dashboard'
          - type: button
            text: 'âš¡ Emergency Procedures'
            url: '{{ (index .Alerts 0).Labels.runbook }}'

  # Alertes IoT/AI
  - name: 'iot-ai-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#station-iot-ai'
        title: 'ğŸ¤– Alerte IoT/IA - Edge Computing'
        title_link: 'https://grafana.johann-lebel.fr'
        text: >-
          {{ range .Alerts }}
          **IoT/IA:** {{ .Annotations.summary }}
          
          ğŸ”¬ *Analyse:* {{ .Annotations.description }}
          ğŸ“¡ *Composant:* `{{ .Labels.service }}`
          ğŸ• *DÃ©tection:* {{ .StartsAt.Format "15:04:05" }}
          ğŸ§  *Diagnostic:* {{ .Labels.runbook }}
          {{ end }}
          
          ğŸ¯ **Performance IA et capteurs IoT**
        color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'
        actions:
          - type: button
            text: 'ğŸ¤– AI Performance'
            url: 'https://grafana.johann-lebel.fr/d/ai/edge-ai-performance'
          - type: button
            text: 'ğŸ“¡ IoT Sensors'
            url: 'https://grafana.johann-lebel.fr/d/iot/iot-sensors-dashboard'
          - type: button
            text: 'ğŸ“ˆ Analytics'
            url: '{{ (index .Alerts 0).Labels.runbook }}'

  # Alertes infrastructure
  - name: 'infrastructure-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#station-infrastructure'
        title: 'ğŸ—ï¸ Infrastructure - Station TraffeyÃ¨re'
        title_link: 'https://grafana.johann-lebel.fr'
        text: >-
          {{ range .Alerts }}
          **Infrastructure:** {{ .Annotations.summary }}
          
          ğŸ“Š *MÃ©triques:* {{ .Annotations.description }}
          ğŸ’» *Ressource:* `{{ .Labels.service }}`
          ğŸ“… *Depuis:* {{ .StartsAt.Format "15:04:05" }}
          ğŸ”§ *Guide:* {{ .Labels.runbook }}
          {{ end }}
        color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'
        actions:
          - type: button
            text: 'ğŸ–¥ï¸ Infrastructure Dashboard'
            url: 'https://grafana.johann-lebel.fr/d/infra/infrastructure-health'
          - type: button
            text: 'ğŸ“‹ Maintenance Guide'
            url: '{{ (index .Alerts 0).Labels.runbook }}'

  # Alertes bases de donnÃ©es
  - name: 'database-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#station-databases'
        title: 'ğŸ—„ï¸ Base de DonnÃ©es - Alertes'
        title_link: 'https://grafana.johann-lebel.fr'
        text: >-
          {{ range .Alerts }}
          **Base de DonnÃ©es:** {{ .Annotations.summary }}
          
          ğŸ’¾ *Performance:* {{ .Annotations.description }}
          ğŸ” *Service:* `{{ .Labels.service }}`
          â° *Timing:* {{ .StartsAt.Format "15:04:05" }}
          ğŸ“š *Documentation:* {{ .Labels.runbook }}
          {{ end }}
        color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'
        actions:
          - type: button
            text: 'ğŸ’¾ Database Dashboard'
            url: 'https://grafana.johann-lebel.fr/d/db/database-performance'
          - type: button
            text: 'ğŸ”§ DB Optimization'
            url: '{{ (index .Alerts 0).Labels.runbook }}'
          - type: button
            text: 'ğŸ“Š Query Analysis'
            url: 'https://grafana.johann-lebel.fr/d/queries/slow-queries'